<?php

/**
 * @file
 */

/**
 * Tests for the OpenBlog Content feature.
 *
 */
class OpenBlogContentTestCase extends DrupalWebTestCase {
  protected $profile = 'openblog';

  public static function getInfo() {
    return array(
      'name' => 'OpenBlog Content',
      'description' => 'Tests the Post content-type in the OpenBlog Content feature.',
      'group' => 'OpenBlog',
    );
  }

  public function setUp() {
    parent::setUp('openblog_content');
  }

  public function testOpenBlogContentDefaultSettings() {
    // TODO: Testing for the markdown filter
    // TODO: Test default blocks

    // Check variables:
    // - Make sure the admin theme is installed
    // - Make sure the logo is set to 0
    // - Test user settings
    // - Test the default homepage
    // - Test allow visitor account creation with administrative approval.
    // - Test settings for ShareThis
    $tests = array(
      'theme_default' => 'subtle_simplicity',
      'admin_theme' => 'seven',
      'user_pictures' => '1',
      'user_picture_dimensions' => '1024x1024',
      'user_picture_file_size' => '800',
      'user_picture_style' => 'thumbnail',
      'site_frontpage' => 'homepage',
      'user_register' => USER_REGISTER_VISITORS_ADMINISTRATIVE_APPROVAL,
      'sharethis_button_option' => 'stbc_hcount',
      'sharethis_location' => 'content',
      'sharethis_node_option' => 'post',
      'sharethis_service_option' => '"Tweet:twitter","Facebook:facebook","ShareThis:sharethis"',
      'sharethis_teaser_option' => 0,
      'sharethis_twitter_suffix' => '',
      'sharethis_weight' => 10,
      'sharethis_widget_option' => 'st_multi',
      'honeypot_element_name' => 'homepage',
      'honeypot_form_comment_node_post_form' => 1,
      'honeypot_form_post_node_form' => 0,
      'honeypot_form_user_pass' => 1,
      'honeypot_form_user_register_form' => 1,
      'honeypot_log' => 0,
      'honeypot_protect_all_forms' => 0,
      'honeypot_time_limit' => '5',
      'date_format_long' => 'l, F j, Y - g:ia',
      'date_format_medium' => 'F j, Y - g:ia',
      'date_format_short' => 'M j Y - H:i'
    );
    foreach($tests as $key => $value) {
      $message = t('The variable "@key" is not @value', array('@key' => $key, '@value' => $value));
      $var = variable_get($key, '');
      $this->assertEqual($var, $value, $message);
    }

    $theme_subtle_simplicity_settings = variable_get('theme_subtle_simplicity_settings', array());
    $toggle_logo = $theme_subtle_simplicity_settings['toggle_logo'];
    $this->assertEqual($toggle_logo, 0, 'The variable "toggle_logo" is not 0');

    $sharethis_option_extras = variable_get('sharethis_option_extras', array());
    $google_plus = $sharethis_option_extras['Google Plus One:plusone'];
    $this->assertEqual($google_plus, 'Google Plus One:plusone', 'The variable "sharethis_option_extras[\'Google Plus One:plusone\']" is not Google Plus One:plusone');

    $facebook_like = $sharethis_option_extras['Facebook Like:fblike'];
    $this->assertEqual($facebook_like, 'Facebook Like:fblike', 'The variable "sharethis_option_extras[\'Facebook Like:fblike\']" is not Facebook Like:fblike');

    // TODO: Test permissions
    // TODO: Test Admin role
  }

  public function testOpenBlogContentInstallSettings() {
    $tests = array(
      'pathauto_node_post_pattern' => 'posts/[node:created:custom:Y]/[node:created:custom:m]/[node:created:custom:d]/[node:title]',
    );
    foreach($tests as $key => $value) {
      $message = t('The variable "@key" is not @value', array('@key' => $key, '@value' => $value));
      $var = variable_get($key, '');
      $this->assertEqual($var, $value, $message);
    }

    $node_options_post = variable_get('node_options_post', array());
    $promote = $node_options_post[0];
    $this->assertEqual($promote, 'promote', 'The variable "node_options_post" is not 0');

    // Make sure post_tags vocabulary exists
    $names = taxonomy_vocabulary_get_names();
    $vocab = $names['post_tags'];
    $this->assertNotNull($vocab, 'the vocabulary post_tags exists');
  }

  public function testOpenBlogContentPostCreate() {
    $user = $this->drupalCreateUser(array(
      'bypass node access',
    ));
    $this->drupalLogin($user);

    $this->drupalGet("/");
    $this->assertResponse(200, t('This should work'));
    // Create node to edit.
    $edit = array();
    $edit['title'] = $this->randomName(8);
    $edit["body[und][0][value]"] = $this->randomName(16);
    $this->drupalPost('node/add/post', $edit, t('Save'));
    $this->assertText(t('Post @title has been created.', array('@title' => $edit['title'])));
  }

  public function testOpenBlogAuthorPostContent() {
    $author = $this->drupalCreateUser(array(
      'create post content',
      'delete own post content',
      'edit own post content',
      'revert revisions',
      'view own unpublished content',
      'view revisions',
    ));
    $this->drupalLogin($author);

    // Create a post
    $edit = array();
    $edit['title'] = $this->randomName(8);
    $edit["body[und][0][value]"] = $this->randomName(16);
    $this->drupalPost('node/add/post', $edit, t('Save'));
    
    // It should have a message from drupal_set_message
    $this->assertText(t('Post @title has been created.', array('@title' => $edit['title'])));

    // Make sure it is unpublished
    $this->drupalGet('/admin/content');
    $this->assertText(t('not published'));

    // Make sure the user can edit a post, we know that this is going to be node 1
    $edit = array();
    $edit['title'] = $this->randomName(8);
    $edit["body[und][0][value]"] = $this->randomName(64);
    $this->drupalPost('node/1/edit', $edit, t('Save'));

    $this->assertText(t('Post @title has been updated.', array('@title' => $edit['title'])));

    // Make sure that the post is listed on the homepage.
    $this->drupalGet('/');
    $this->assertNoText(t('@title', array('@title' => $edit['title'])), 'The published node does not display on the homepage.');

    // Make sure the author cannot do anything with 
    $this->drupalGet('node/add/post');
    $this->assertNoText(t('Menu settings'), 'The text "Menu settings" appears on the Post add page.');
    $this->assertNoText(t('Revision information'), 'The text "Revision information" appears on the Post add page.');
    $this->assertNoText(t('URL path settings'), 'The text "URL path settings" appears on the Post add page.');
    $this->assertNoText(t('Comment settings'), 'The text "Comment settings" appears on the Post add page.');
    $this->assertNoText(t('Authoring information'), 'The text "Authoring information" appears on the Post add page.');
    $this->assertNoText(t('Publishing options'), 'The text "Publishing options" appears on the Post add page.');
  }

  public function testOpenBlogEditorPostContent() {
    $editor = $this->drupalCreateUser(array(
      'bypass node access',
      'administer comments',
      'administer nodes',
      'administer users',
      'assign author role',
      'assign editor role',
      'create post content',
      'delete own post content',
      'delete any post content',
      'edit own post content',
      'edit any post content',
      'revert revisions',
      'view own unpublished content',
      'view revisions',
    ));
    $this->drupalLogin($editor);

    // Create a post
    $edit = array();
    $edit['title'] = $this->randomName(8);
    $edit["body[und][0][value]"] = $this->randomName(16);
    $this->drupalPost('node/add/post', $edit, t('Save'));
    
    // It should have a message from drupal_set_message
    $this->assertText(t('Post @title has been created.', array('@title' => $edit['title'])));

    // Make sure it is unpublished
    $this->drupalGet('/admin/content');
    $this->assertText(t('not published'));

    // Make sure the user can edit a post, we know that this is going to be node 1
    $edit = array();
    $edit['title'] = $this->randomName(8);
    $edit["body[und][0][value]"] = $this->randomName(64);
    $edit["status"] = 1;
    $this->drupalPost('node/1/edit', $edit, t('Save'));

    $this->assertText(t('Post @title has been updated.', array('@title' => $edit['title'])));

    // Make sure that the post is listed on the homepage.
    $this->drupalGet('/');
    $this->assertText(t('@title', array('@title' => $edit['title'])), 'The published node does not display on the homepage.');

    // Make sure the author cannot do anything with 
    $this->drupalGet('node/add/post');
    $this->assertNoText(t('Menu settings'), 'The text "Menu settings" appears on the Post add page.');
    $this->assertText(t('Revision information'), 'The text "Revision information" appears on the Post add page.');
    $this->assertNoText(t('URL path settings'), 'The text "URL path settings" appears on the Post add page.');
    $this->assertText(t('Comment settings'), 'The text "Comment settings" appears on the Post add page.');
    $this->assertText(t('Authoring information'), 'The text "Authoring information" appears on the Post add page.');
    $this->assertText(t('Publishing options'), 'The text "Publishing options" appears on the Post add page.');
  }
}

